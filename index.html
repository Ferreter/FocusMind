<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />
  <!-- 
    <meta
      http-equiv="Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    <meta
      http-equiv="X-Content-Security-Policy"
      content="default-src 'self'; script-src 'self'"
    />
    sidebar code -->
  <title>Focus Mode</title>
  <!-- Using Boxivons because they have more veriety -->
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-..."> -->
  <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
  <script src="https://kit.fontawesome.com/b81fdd1146.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="css/styles.css">
  <link rel="stylesheet" href="css/floating-button.css">
  <link rel="stylesheet" href="css/frame.css">
  <link rel="stylesheet" href="css/loading-animation.css">
  <link rel="stylesheet" href="css/dashboard.css">
  <link rel="stylesheet" href="css/congrats-modal.css">
  <link rel="stylesheet" href="css/sidebar.css">
  <!--bootstrap-->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
</head>

<body>
  <div id="title-bar">
    <div id="title" style="padding-left: 5px;">Focus Mind</div>
    <div id="buttons">
      <div id="minimize-btn">&#x2500;</div>
      <div id="close-btn">&#x2715;</div>
    </div>
  </div>
  <!-- sidebar code -->

  <nav class="sidebar close" style="margin-top: 45px; background-color: #FEF6EB;">
    <header>
      <div class="image-text">
        <span class="image">
          <img src="images/focus mind.png" alt="logo" />
        </span>

        <div class="text header-text">
          <span class="name">FocusMind</span>
        </div>
      </div>

      <i class='bx bx-chevron-right toggle'></i>
    </header>

    <div class="menu-bar">
      <div class="menu">
        <ul class="menu-links">
          <li class="nav-links">
            <a href="#">
              <i class='bx bx-list-ul icon'></i>
              <span class="text nav-text">Overview</span>
            </a>
          </li>
          <li class="nav-links">
            <a href="src/Analytics.html">
              <i class='bx bxs-bar-chart-alt-2 icon'></i>
              <span class="text nav-text">Analytics</span>
            </a>
          </li>
          <li class="nav-links">
            <a href="src/focus.html">
              <i class='bx bx-crosshair icon'></i>
              <span class="text nav-text">Focus Timer</span>
            </a>
          </li>
          <li class="nav-links">
            <a href="src/calender.html">
              <i class='bx bx-calendar-event icon'></i>
              <span class="text nav-text">Calender</span>
            </a>
          </li>
          <li class="nav-links">
            <a href="src/settings.html">
              <i class='bx bx-cog icon'></i>
              <span class="text nav-text">Settings</span>
            </a>
          </li>
        </ul>
      </div>
    </div>

    <div class="bottom-content">
      <div class="toggle-switch">
        <span class="switch"></span>
      </div>
    </div>

  </nav>


  <section class="home">

    <!-- main app -->

    <div class="text">
      Dashboard
      <hr>
      <div class="container">
        <div class="row">
          <div class="col-md" align="center">
            <div class="circle">12</div>
            <h3 style="margin-top: 40px;">Hours Focused This Week</h3>
          </div>
          <div class="col-md circle-glow">
            <div class="circle">200</div>
            <h3 style="margin-top: 40px;">Hours spent on blocked<br> app/websites</h3>
          </div>
        </div>
        <div class="button-wrapper">
          <button id="focus-btn" onclick="startFocus()" type="button" class="btn btn-success start-focus">Start
            Focusing</button>
        </div>

      </div>


    </div>

  </section>

  <!-- Floating Button -->
  <div class="floating-btn">
    <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#moodModal">
      How are you feeling today?
    </button>
  </div>

  <!--Mood Modal -->
  <div class="modal fade" id="moodModal" tabindex="-1" role="dialog" aria-labelledby="moodModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="moodModalLabel">Describe your mood</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body text-center"> <!-- Follow Niko Modal Here-->

          <div class="d-inline-block text-center">
            <span class="emoji" onclick="saveMood('üòí')" title="Low">üòí</span>
            <br>
            <span class="subtitle">Low</span>
          </div>

          <div class="d-inline-block text-center">
            <span class="emoji" onclick="saveMood('üòï')" title="Mild">üòï</span>
            <br>
            <span class="subtitle">Mild</span>
          </div>

          <div class="d-inline-block text-center">
            <span class="emoji" onclick="saveMood('üòê')" title="Neutral">üòê</span>
            <br>
            <span class="subtitle">Neutral</span>
          </div>

          <div class="d-inline-block text-center">
            <span class="emoji" onclick="saveMood('üòä')" title="Moderate">üòä</span>
            <br>
            <span class="subtitle">Moderate</span>
          </div>

          <div class="d-inline-block text-center">
            <span class="emoji" onclick="saveMood('üòÄ')" title="Content">üòÄ</span>
            <br>
            <span class="subtitle">Content</span>
          </div>

        </div>

      </div>
    </div>
  </div>

  <!-- Modal Congrats -->
  <div class="modal fade" id="congratulationsModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
    aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Congratulations!</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="card-body text-center"> <img src="https://img.icons8.com/bubbles/200/000000/trophy.png">
            <p>You were focused for: <span id="focusedTime">0 minutes</span>.</p>
            <p>Describe your mood based on the outcome of this session.</p>
            <div class="d-inline-block text-center">
              <span class="emoji" onclick="saveMood('üòí')" title="Low">üòí</span>
              <br>
              <span class="subtitle">Sad</span>
            </div>
            <div class="d-inline-block text-center">
              <span class="emoji" onclick="saveMood('üòï')" title="Mild">üòï</span>
              <br>
              <span class="subtitle">Angry</span>
            </div>
            <div class="d-inline-block text-center">
              <span class="emoji" onclick="saveMood('üòê')" title="Neutral">üòê</span>
              <br>
              <span class="subtitle">Happy</span>
            </div>
            <div class="d-inline-block text-center">
              <span class="emoji" onclick="saveMood('üòä')" title="Moderate">üòä</span>
              <br>
              <span class="subtitle">Confused</span>
            </div>
            <div class="d-inline-block text-center">
              <span class="emoji" onclick="saveMood('üòÄ')" title="Content">üòÄ</span>
              <br>
              <span class="subtitle">Confused</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    var selectedMood = '';

    // Load existing mood data from JSON file
    let moodData = {};
    try {
      const data = fs.readFileSync('database/mood_data.json', 'utf8');
      moodData = JSON.parse(data);
    } catch (err) {
      console.error("Error reading or parsing JSON file:", err);
    }

    // Initialize mood entries array if not already defined
    if (!moodData.moodEntries) {
      moodData.moodEntries = [];
    }

    // Initialize mood counts if not already defined
    if (!moodData.TotalMood) {
      moodData.TotalMood = {
        'üòí': 0,
        'üòï': 0,
        'üòê': 0,
        'üòä': 0,
        'üòÄ': 0
      };
    }

    // Define a function to update mood counts and save data to JSON file
    function saveMoodData(selectedMood) {
      // Update mood count
      moodData.TotalMood[selectedMood]++;

      // Create a mood entry with mood and timestamp
      const moodEntry = {
        mood: selectedMood,
        timestamp: new Date().toISOString()
      };

      // Add the new mood entry to the array
      moodData.moodEntries.push(moodEntry);

      // Write the updated mood data back to the JSON file
      fs.writeFile('database/mood_data.json', JSON.stringify(moodData, null, 2), 'utf8', (err) => {
        if (err) {
          console.error("Error writing JSON file:", err);
        } else {
          console.log("Mood data saved successfully.");
        }
      });
    }


    function saveMood(mood) {
      selectedMood = mood;
      console.log('Selected Mood: ' + selectedMood);
      saveMoodData(selectedMood); // Save the selected mood
      $('#moodModal').modal('hide'); // Close the modal
    }
  </script>

  <!-- Insert this line above script imports, required for electron node integration  -->
  <script>if (typeof module === 'object') { window.module = module; module = undefined; }</script>


  <!-- Bootstrap JS and dependencies -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
  <!-- Code for other js files-->
  <script src="js/sidebar-render.js"></script>
  <script src="js/renderer.js"></script>
  <script src="js/scripts.js"></script>

  <!-- Insert this line after script imports -->
  <script>if (window.module) module = window.module;</script>

  <!--Timer Start Code-->

  <!--Functions-->
  <script>
    // Function to disable links
    function disableLinks() {
      var links = document.querySelectorAll('.menu-links a');
      links.forEach(function (link) {
        link.classList.add('disabled'); // Add 'disabled' class
      });
    }

    // Function to enable links
    function enableLinks() {
      var links = document.querySelectorAll('.menu-links a');
      links.forEach(function (link) {
        link.classList.remove('disabled'); // Remove 'disabled' class
      });
    }

    function showCongratulationsModal() {
      focusedTime = totalDuration - remainingDuration; // Calculate focused time
      document.getElementById('focusedTime').innerText = formatTime(focusedTime);
      $('#congratulationsModal').modal('show');
      console.log("Congratulations! You were focused for " + formatTime(focusedTime) + ".");
      //print distractions from the variable and the value that it is at now
      console.log("distractions: " + (getDistraction()  - distractions));
      //print start time and end time
      console.log("Start Time: " + startTimer);
      console.log("End Time: " + endTimer);
      // Add session analytics
      addSessionAnalytics(startTimer, endTimer, formatTime(focusedTime), getDistraction()  - distractions, selectedMood);

    }

    function updateTimerDisplay(elapsedMillis) {
      var elapsedSeconds = Math.floor(elapsedMillis / 1000);
      var remainingTime = Math.max(0, remainingDuration - elapsedSeconds); // Ensure remaining time is non-negative
      button.innerHTML = 'Time Left ' + formatTime(remainingTime);
    }

    function formatTime(seconds) {
      var minutes = Math.floor(seconds / 60);
      seconds = seconds % 60;
      return padLeft(minutes) + ':' + padLeft(seconds);
    }

    function padLeft(value) {
      return value < 10 ? '0' + value : value;
    }

  </script>
  <script>
    const fs = require('fs');

    try {
      const data = JSON.parse(fs.readFileSync('database/settings.json', 'utf8'));
      var BlackoutTimer = data.BlackoutModeSettings.Timer;
      var Duration = data.BlackoutModeSettings.Duration;

    } catch (error) {
      console.error('Error reading or parsing JSON:', error);
    }

    function getDistraction() {
      try {
        const data = JSON.parse(fs.readFileSync('database/analytics.json', 'utf8'));
        return data.appAnalytics.appsClosed;

      } catch (error) {
        console.error('Error reading or parsing JSON:', error);
      }
    }

  </script>
  <!--Focus code starts here-->
  <script>
    var blackoutAmount = 0;
    var blackoutLength = 0; // Stores cumulative duration in seconds
    var isFocusing = false;
    var startTime;
    var button = document.getElementById('focus-btn');
    var totalDuration = 60 * 60; // 60 minutes in seconds
    var remainingDuration = totalDuration; // Initialize remaining duration to 60 minutes
    var startTimer;
    var endTimer;
    var distractions = getDistraction();

    function startFocus() {
      // go to different page
      // window.location.href = "src/focus.html";
      if (!isFocusing) {
        beginFocus();
        console.log("distractions: " + distractions);
        startTimer = new Date().getTime();
      } else {
        endTimer = new Date().getTime();
        endFocus();
      }
    }



    function addSessionAnalytics(startTime, endTime, focusDurationMinutes, distractions, notes) {
      // Calculate session duration in seconds
      const sessionDurationSeconds = (endTime - startTime) / 1000;

      // Read the current contents of the analytics file
      fs.readFile('database/focus_sessions.json', 'utf8', (err, data) => {
        if (err) {
          console.error("Error reading the analytics file:", err);
          return;
        }

        // Parse the JSON data
        let analyticsData = JSON.parse(data);

        // Create a new session object
        const newSession = {
          "start_time": new Date(startTime).toISOString(),
          "end_time": new Date(endTime).toISOString(),
          "focus_duration_minutes": focusDurationMinutes,
          "distractions": distractions,
          "notes": notes
        };

        // Add the new session to the analytics
        if (!analyticsData.sessions) {
          analyticsData.sessions = [];
        }
        analyticsData.sessions.push(newSession);

        // Write the updated data back to the file
        fs.writeFile('database/focus_sessions.json', JSON.stringify(analyticsData, null, 2), 'utf8', (err) => {
          if (err) {
            console.error("Error writing to the analytics file:", err);
            return;
          }
          console.log("Session analytics added successfully.");
        });
      });
    }

    function beginFocus() {
      ipcRenderer.send('notif'); // sends notification IPC to main.js for python file
      disableLinks();
      startTime = new Date().getTime();
      isFocusing = true;
      startInterval(ipcRenderer, 'focus', 2000);
      startInterval(ipcRenderer, 'blackout', 10000);
      updateTimerDisplayInterval();
      updateButtonContent("Time Left:" + formatTime(remainingDuration));
    }

    function triggerBlackoutAnalytics() {
      // Read the current contents of the file
      fs.readFile('database/analytics.json', 'utf8', (err, data) => {
        if (err) {
          console.error("Error reading the file:", err);
          return;
        }
        // Parse the JSON data
        let jsonData = JSON.parse(data);

        // Increment the blackoutAmount
        jsonData.Blackout.blackoutAmount += 1;

        // Convert the updated object back to a JSON string
        const updatedData = JSON.stringify(jsonData, null, 2); // The second argument null and 2 for pretty-printing
        // Write the updated data back to the file
        fs.writeFile('database/analytics.json', updatedData, 'utf8', (err) => {
          if (err) {
            console.error("Error writing to the file:", err);
            return;
          }
          console.log("Successfully updated blackoutAmount.");
        });
      });
    }

    function triggerBlackoutDurationAnalytic() {
      const data = JSON.parse(fs.readFileSync('database/settings.json', 'utf8'));
      var Duration = data.BlackoutModeSettings.Duration;

      fs.readFile('database/analytics.json', 'utf8', (err, data) => {
        if (err) {
          console.error('Error reading JSON file:', err);
          return;
        }

        try {
          // Parse the JSON data
          const analytics = JSON.parse(data);

          // Modify the value (for example, incrementing BlackoutTimer)
          analytics.Blackout.blackoutTime += Duration;

          // Convert the modified object back to JSON format
          const updatedData = JSON.stringify(analytics, null, 2);

          // Write the updated JSON back to the file
          fs.writeFile('database/analytics.json', updatedData, 'utf8', (err) => {
            if (err) {
              console.error('Error writing JSON file:', err);
              return;
            }
            console.log('JSON file updated successfully for Duration.');
          });
        } catch (error) {
          console.error('Error parsing JSON:', error);
        }
      });
    }

    function endFocus() {
      isFocusing = false;
      enableLinks();
      remainingDuration -= Math.floor((new Date().getTime() - startTime) / 1000);
      resetButton();
      confettiCaller();
      showCongratulationsModal();
      resetTimers();
    }

    function startInterval(target, message, interval) {
      var intervalId = setInterval(function () {
        if (!isFocusing) {
          clearInterval(intervalId); // Stop the interval if isFocusing is false
          return;
        }
        console.log("Sent " + message);
        target.send(message);
        if (message === 'blackout') {
          triggerBlackoutAnalytics();
          triggerBlackoutDurationAnalytic();
        }
      }, interval);
    }

    function updateTimerDisplayInterval() {
      setInterval(function () {
        if (isFocusing) {
          updateTimerDisplay(new Date().getTime() - startTime);
        }
      }, 1000);
    }

    function updateButtonContent(content) {
      button.innerHTML = content;
    }

    function resetButton() {
      updateButtonContent('Start Focusing');
      button.style.backgroundColor = 'green';
    }

    function resetTimers() {
      focusedTime = 0;
      totalDuration = 60 * 60;
      remainingDuration = totalDuration;
    }

  </script>
  <!-- Pre loader Script 
    <script>
    var loader = document.getElementById("preloader");
      window.addEventListener("load", function(){
       loader.style.display = "none";
     });
    </script> 
  -->
</body>

</html>